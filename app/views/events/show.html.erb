<script type="text/javascript">
$(function(){
    // 「.modal-open」をクリック
    $('.modal-open').click(function(){
        // オーバーレイ用の要素を追加
        $('body').append('<div class="modal-overlay"></div>');
        // オーバーレイをフェードイン
        $('.modal-overlay').fadeIn('fast');

        // モーダルコンテンツのIDを取得
        var modal = '#' + $(this).attr('data-target');
        // モーダルコンテンツの表示位置を設定
        modalResize();
         // モーダルコンテンツフェードイン
        $(modal).fadeIn('fast');

        // 「.modal-overlay」あるいは「.modal-close」をクリック
        $('.modal-overlay, .modal-close').off().click(function(){
            // モーダルコンテンツとオーバーレイをフェードアウト
            $(modal).fadeOut('fast');
            $('.modal-overlay').fadeOut('fast',function(){
                // オーバーレイを削除
                $('.modal-overlay').remove();
            });
        });

        // リサイズしたら表示位置を再取得
        $(window).on('resize', function(){
            modalResize();
        });

        // モーダルコンテンツの表示位置を設定する関数
        function modalResize(){
            // ウィンドウの横幅、高さを取得
            var w = $(window).width();
            var h = $(window).height();

            // モーダルコンテンツの表示位置を取得
            var x = (w - $(modal).outerWidth(true)) / 2;
            var y = (h - $(modal).outerHeight(true)) / 2;

            // モーダルコンテンツの表示位置を設定
            $(modal).css({'left': x + 'px','top': y + 'px'});
        }
    });
  
  // materializeのselect要素を初期化(https://materializecss.com/select.html)
  $(document).ready(function(){
    $('select').formSelect();
  });
});
</script>

<% provide(:title, "イベント詳細") %>
<h1>イベント詳細</h1>
<table>
  <tr>
    <th>イベント名</th>
    <td><%= @event.title %></td>
  </tr>
  <tr>
    <th></th>
    <td>
      <a data-target="decision_set" class="waves-effect waves-light btn modal-open">日程入力</a>
      <a data-target="member_add" class="waves-effect waves-light btn modal-open">メンバー追加</a>
    </td>
  </tr>
  <tr>
    <th>開催日候補</th>
    <td>
      <table id ="date_list" class="uk-table uk-table-striped">
        <tr>
          <th>日付</th>
          <th>(集計)</th>
          <% @member.each do |obj| %>
            <th><%= obj.user.username %></th>
          <% end %> 
        </tr>
        <% @decisionDate.each do |date| %>
          <tr>
            <td><%= date.day.strftime('%Y/%m/%d') %></td>
            <% @decisionDateSum.each do |dateSum| %>
              <% if dateSum.day == date.day %>
                <td><%= dateSum.proprieties_count %></td>
              <% end %>
            <% end %>
            <% @decisionUser.each do |user| %>
              <% if user.day == date.day %>
                <td><%= user.propriety %></td>
              <% end %>
            <% end %>
          </tr>
        <% end %>
      </table>
    </td>
  </tr>
  <tr>
    <th>URL(お店、イベントページなど)</th>
    <td><%= @event.url %></td>
  </tr>
  <tr>
    <th>会費</th>
    <td><%= @event.fee %></td>
  </tr>
  <tr>
    <th>イベント詳細</th>
    <td><%= @event.detail %></td>
  </tr>
  <% if @event.user_id == @current_user_id %>
  <tr>
    <th></th>
    <td><%= link_to('編集', "/events/edit/#{@event.id}/", :action => 'edit', :class => 'waves-effect waves-light btn') %></td>
  </tr>
  <% end %>
</table>

<!-- メンバー追加 -->
<div id="member_add" class="modal-content">
  <p>追加するメンバーを、Twitterリストから選択してください</p>
  <table>
    <% @owned_lists.each do |obj| %>
      <tr>
        <td><%= link_to(obj.name, :action => 'show', :list => obj.name) %></td>
        <td><%= obj.member_count %></td>
        <td><%= obj.description %></td>
      </tr>
    <% end %>
  </table>
  <a class="modal-close waves-effect waves-light btn">閉じる</a>
</div>

<!-- 日程入力 -->
<div id="decision_set" class="modal-content">
  <% @member.each do |obj| %>
    <% if obj.user_id == @current_user_id %>
      <p>ユーザ：<%= obj.user.username %></p>
      <%= form_tag({controller: 'events', action: 'adjustment'}, {method: :post}) do %>
        <% @decisionDate.each do |date| %>
          <div class="row">
            <div class="input-field col s6">
              <%= date.day.strftime('%Y/%m/%d') %>
            </div>
            <% @decisionUser.each do |user| %>
              <% if user.day == date.day && user.user_id == @current_user_id %>
                <div class="input-field col s6">
                  <%= select_tag('propriety', options_for_select(@proprieties_for_options, user.propriety_before_type_cast), class:'option', name: 'propriety[]') %>
                </div>
              <% end %>
            <% end %>
          </div>
        <% end %>
        <%= submit_tag "保存", class: "waves-effect waves-light btn" %>
      <% end %>
    <% end %>
  <% end %>
</div>